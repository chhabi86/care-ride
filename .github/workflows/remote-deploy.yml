name: Remote Deploy to Ubuntu Server

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  remote-deploy:
    name: Remote deploy (SSH)
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        run: |
          set -eo pipefail
          echo "Setting up SSH key..."
          
          # Setup SSH key
          printf "%s\n" "${{ secrets.DEPLOY_SSH_KEY }}" > /tmp/deploy_key
          
          # Convert literal \n sequences to real newlines if present
          if grep -q '\\n' /tmp/deploy_key; then
            sed -e 's/\\n/\n/g' /tmp/deploy_key > /tmp/deploy_key.tmp && mv /tmp/deploy_key.tmp /tmp/deploy_key
          fi
          
          # Strip CR and set permissions
          sed -i 's/\r$//' /tmp/deploy_key || true
          chmod 600 /tmp/deploy_key
          
          # Test SSH connection with retry
          for attempt in {1..5}; do
            echo "SSH connection attempt $attempt of 5 to ${{ secrets.DEPLOY_HOST }}"
            
            if timeout 30 ssh -o ConnectTimeout=10 \
                             -o StrictHostKeyChecking=no \
                             -o BatchMode=yes \
                             -i /tmp/deploy_key \
                             "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
                             "echo 'SSH test successful'"; then
              echo "‚úÖ SSH connection successful"
              break
            else
              echo "‚ùå SSH attempt $attempt failed"
              if [ $attempt -lt 5 ]; then
                sleep 10
              else
                echo "‚ùå All SSH attempts failed"
                exit 1
              fi
            fi
          done
          
          echo "üéâ Remote deploy test completed!"
